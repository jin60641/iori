<meta charset="utf-8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
<meta http-equiv="Content-Type" content="text/html; charset="utf-16" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="">
<meta name="format-detection" content="telephone=no">
<link rel="stylesheet" type="text/css" href="/css/head.css">
<link rel="stylesheet" type="text/css" href="/css/popup.css">
<script src="/js/listener.js"></script>
<script src="/js/socketio.js"></script>
<script src="/js/socket.js"></script>
<script>

function getCookie(cname) {
	var cookie_array = document.cookie.split(', ');
	for(var i = 0; i < cookie_array.length; ++i ){
		if( cname == cookie_array[i].split('=')[0] ){
			return cookie_array[i].split('=')[1];
		}
	}
	return "";
}

session = "<%= session %>".replace(/&#34;/g,'"');
if( session.length > 0 ){
	session = JSON.parse(session)
} else if( document.cookie ){
	if ( getCookie("facebook") == "true" ){
		var returnTo = document.URL.split('/').slice(3).toString();
		location.href = "/api/auth/facebook/" + returnTo;
	} else if( ( getCookie("email") || getCookie("userid") ) && getCookie("password") ){
		var params = "password=" + getCookie("password") + "&";
		if( getCookie("email") ){
			params += "email=" + getCookie("email");
		} else {
			params += "userid=" + getCookie("userid");
		}
		var xhr = new XMLHttpRequest();
		xhr.onreadystatechange = function(event){
			if( xhr.readyState == 4 && xhr.status == 200 ){
				if( xhr.responseText == "success" ){
					if( document.URL.indexOf("login") ){
						location.href = "/" + document.URL.split('/').slice(4).toString().split('-').join('/');
					} else {
						location.reload()
					}
				}
			}
		}
		console.log(params);
		xhr.open("POST", "/api/auth/local", false);
		xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
		xhr.send(params);
	}
}
if( session.level >= 9 ){
	//관리자
} else {
	/*
		if( url[0] == "" ){
			location.href = "/login/index";
		} else if( url[0] == "login" ){
			location.reload();
		} else {
			location.href = "/login/" + document.URL.split('/').slice(3).join("-");
		}
	*/
}

//친구검색(헤더)
function sendData_search( query ){
	if( query ){
		var xhr = new XMLHttpRequest();
		xhr.onreadystatechange = function (event){ if(xhr.readyState == 4 && xhr.status == 200) {
			var result = search_result;
			if( xhr.responseText != "[]" ){
				result.innerHTML="";
				var xhrResult = JSON.parse( xhr.responseText );
				if( xhrResult.length ){
					for( var i = xhrResult.length - 1; i>=0; i--){
						result.innerHTML+='<a href="/@' + xhrResult[i].user_id + '"><div><img src="/profileimg/' + xhrResult[i].id + '">' + xhrResult[i].name.toString() + '</div></a>';
					}
				} else {
					result.innerHTML+='<div><img src="/profileimg/' + xhrResult.id + '"><a href="/@' + xhrResult.user_id + '">' + xhrResult.name.toString() + '</a></div>';
				}
			} else {
				result.innerHTML='<div id="search_none">표시할 검색 결과가 없습니다.</div>';
			}
		}}
		xhr.open("POST", "/api/user/search", false); xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); xhr.send('query='+query);
	} else {
		search_result.innerHTML='<div id="search_none">표시할 검색 결과가 없습니다.</div>';
	}
}

function getNotices(cnt){
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function (event){ if(xhr.readyState == 4 && xhr.status == 200){
		if( xhr.responseText ){
			notice.innerHTML = xhr.responseText;
		} else {
			notice.innerHTML = 0;
		}
	}}
	xhr.open("POST", "/api/newsfeed/getnotice", false); xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); xhr.send('cnt='+cnt);
}



function head_menu_show(boolean){
	event.stopPropagation();
	if( boolean != undefined ){
		if( boolean ){
			head_menu.style.display = "block";
		} else {
			head_menu.style.display = "none";
		}
	} else if( head_menu.style.display == "block" ){
		head_menu.style.display = "none";
	} else {
		head_menu.style.display = "block";
	}
}


window.addEventListener('load',function(){
	head = document.createElement("div");
	document.body.insertBefore(head,document.body.firstChild);
	head.id="head";
	var head_a = document.createElement("a");
	head_a.className = "navi_menu";
	head_a.innerHTML = "<img src='/profileimg/" + session.id + "' id='profileimg_head' >";
	//	head.innerHTML = "<a href='/@" + session.user_id + "' class='navi_menu' style='padding-left:35px;'><img src='/profileimg/" + session.id + "' id='profileimg_head' >" + session.name + "</a>";
	if( session == "" ){
		head_a.href = "/login";
	//	head_a.innerHTML += "로그인해주세요";
	} else {
		head_a.href = "/@" + session.user_id;
		//head_a.innerHTML += session.name;
	}
	head.appendChild(head_a);
//  head.innerHTML += "<div id='notice' class='navi_menu' style='border-left:1px solid white;'></div>";
	head.innerHTML+="<input type='text' name='query' onkeyup='return sendData_search(this.value);' placeholder='친구 찾기' onfocusout='search_result_none()' onfocus='document.getElementById(\"search_result\").style.display=\"block\";' id='search' onclick='head_menu_show(false);' onsubmit='return false;' autocomplete='off'>";
	head.innerHTML+="<div id='search_result' onmouseover='search_result_view=1;' onmouseout='search_result_view=0';><div id='search_none'>표시할 검색 결과가 없습니다.</div></div>";
	head.innerHTML+="<img src='/img/logo_orange.png' id='head_logo' onclick='head_menu_show()'>";
	window.addEventListener('click', function(){
		head_menu.style.display = "none";
		search_result.style.display = "none";
	});
	head_menu = document.createElement("div");
	head_menu.id = "head_menu";
	head_menu.innerHTML += "<a href='/'><img src='/img/menu_home.png'>| 홈</a>";
	head_menu.innerHTML += "<a href='/room'><img src='/img/menu_game.png'>| 게임</a>";
	head_menu.innerHTML += "<a href='/ranking'><img src='/img/menu_ranking.png'>| 랭킹</a>";
	if( session == "" ){
	} else {
		head_menu.innerHTML += "<a href='#' onclick='sessionLogOut(this)' ><img src='/img/menu_logout.png'>| 로그아웃</a>";
	}

	head_menu.style.display = "none";
	head.appendChild(head_menu);
	//<span onclick='sessionLogOut()'>로그아웃</span>";
	search_result = document.getElementById("search_result");

	//getNotices(0);
	/*
	notice.addEventListener('click', function(){
		if( parseInt( this.innerHTML ) >= 1 ){
			var xhr2 = new XMLHttpRequest();
			xhr2.onreadystatechange = function (event){ if(xhr2.readyState == 4 && xhr2.status == 200){
				var notices = JSON.parse( xhr2.responseText );
				console.log(notices);
				for( var i = 0; i < notices.length; ++i ){
					console.log(notices[i]);
					//notice_box.innerHTML =
				}
			}}
			xhr2.open("POST", "/api/newsfeed/getnotice", false); xhr2.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); xhr2.send('cnt='+parseInt(notice.innerHTML));
		}
	});
	*/
});























</script>
