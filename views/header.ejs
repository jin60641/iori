<meta charset="utf-8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
<meta http-equiv="Content-Type" content="text/html; charset="utf-16" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="">
<meta name="format-detection" content="telephone=no">
<link rel="stylesheet" type="text/css" href="/css/head.css">
<link rel="stylesheet" type="text/css" href="/css/popup.css">
<script src="/js/listener.js"></script>
<script src="/js/socketio.js"></script>
<script src="/js/socket.js"></script>
<script>

function getCookie(cname) {
	var cookie_array = document.cookie.split(', ');
	for(var i = 0; i < cookie_array.length; ++i ){
		if( cname == cookie_array[i].split('=')[0] ){
			return cookie_array[i].split('=')[1];
		}
	}
	return "";
}

session = "<%= session %>".replace(/&#34;/g,'"');
if( session.length > 0 ){
	session = JSON.parse(session)
} else if( document.cookie ){
	if ( getCookie("facebook") == "true" ){
		var returnTo = document.URL.split('/').slice(3).toString();
		location.href = "/api/auth/facebook/" + returnTo;
	} else if( getCookie("userid") && getCookie("password") ){
		var params = "password=" + getCookie("password") + "&userid=" + getCookie("userid");
		var xhr = new XMLHttpRequest();
		xhr.onreadystatechange = function(event){
			if( xhr.readyState == 4 && xhr.status == 200 ){
				if( xhr.responseText == "success" ){
					if( document.URL.indexOf("login") ){
						location.href = "/" + document.URL.split('/').slice(4).toString().split('-').join('/');
					} else {
						location.reload()
					}
				}
			}
		}
		xhr.open("POST", "/api/auth/local", false);
		xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
		xhr.send(params);
	}
}
if( session.level >= 9 ){
	//관리자
} else {
	/*
		if( url[0] == "" ){
			location.href = "/login/index";
		} else if( url[0] == "login" ){
			location.reload();
		} else {
			location.href = "/login/" + document.URL.split('/').slice(3).join("-");
		}
	*/
}

//친구검색(헤더)
function sendData_search( query ){
	if( query ){
		var xhr = new XMLHttpRequest();
		xhr.onreadystatechange = function (event){ if(xhr.readyState == 4 && xhr.status == 200) {
			var result = search_result;
			if( xhr.responseText != "[]" ){
				result.innerHTML="";
				var xhrResult = JSON.parse( xhr.responseText );
				if( xhrResult.length ){
					for( var i = xhrResult.length - 1; i>=0; i--){
						result.innerHTML+='<a href="/@' + xhrResult[i].user_id + '"><div><img src="/profileimg/' + xhrResult[i].id + '"><span><div class="search_result_userid">@' + xhrResult[i].user_id.toString() + '</div>' + xhrResult[i].name.toString() + '</span></div></a>';
					}
				}
			} else {
				result.innerHTML='<div id="search_none">표시할 검색 결과가 없습니다.</div>';
			}
		}}
		xhr.open("POST", "/api/user/search", false); xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); xhr.send('query='+query);
	} else {
		search_result.innerHTML='<div id="search_none">표시할 검색 결과가 없습니다.</div>';
	}
}

function getNotices(cnt){
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function (event){ if(xhr.readyState == 4 && xhr.status == 200){
		if( xhr.responseText ){
			notice.innerHTML = xhr.responseText;
		} else {
			notice.innerHTML = 0;
		}
	}}
	xhr.open("POST", "/api/newsfeed/getnotice", false); xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); xhr.send('cnt='+cnt);
}

window.addEventListener('load',function(){
	var head = document.createElement("div");
	document.body.insertBefore(head,document.body.firstChild);
	head.id="head";


//  head.innerHTML += "<div id='notice' class='navi_menu' style='border-left:1px solid white;'></div>";
	head.innerHTML+="<input type='text' name='query' onkeyup='return sendData_search(this.value);' placeholder='친구 찾기' onfocusout='searchResultNone()' onfocus='document.getElementById(\"search_result\").style.display=\"block\";' id='search' onclick='head_menu_show(false);' onsubmit='return false;' autocomplete='off'>";
	head.innerHTML+="<div id='search_result' onmouseover='searchResultView=1;' onmouseout='searchResultView=0';><div id='search_none'>표시할 검색 결과가 없습니다.</div></div>";
	head.innerHTML+="<img src='/img/logo_orange.png' id='head_logo' onclick='goTop()'>";
	window.addEventListener('click', function(){
		head_menu.style.display = "none";
		search_result.style.display = "none";
	});

	var navi_search = document.createElement("div");
	navi_search.id = "navi_search";
	navi_search.innerHTML = "<a href='/search' ><img src='/img/navi_search.jpg'></a>";
	head.appendChild(navi_search);

	var navi_profile = document.createElement("div");
	navi_profile.id = "navi_profile";
	navi_profile.innerHTML = "<img src='/profileimg/" + session.id + "'>";
	if( session == "" ){
		navi_profile.onclick = function(){
			location.href = "/login/" + document.URL.split('/').slice(3).join("-");
		}
	} else {
		navi_profile.onclick = head_menu_show;
	}
	head.appendChild(navi_profile);

	var head_menu = document.createElement("div");
	head_menu.id = "head_menu";
	head_menu.innerHTML += "<div class='dropdown_caret'><div class='caret_outer'></div><div class='caret_inner'></div></div>";
	head_menu.innerHTML += "<a href='/'><img src='/img/menu_home.png'>| 홈</a>";
	head_menu.innerHTML += "<a href='/room'><img src='/img/menu_game.png'>| 게임</a>";
	head_menu.innerHTML += "<a href='/ranking'><img src='/img/menu_ranking.png'>| 랭킹</a>";
	if( session == "" ){
	} else {
		head_menu.innerHTML += "<a href='#' onclick='sessionLogOut(this)' ><img src='/img/menu_logout.png'>| 로그아웃</a>";
	}

	head_menu.style.display = "none";
	head.appendChild(head_menu);
	//<span onclick='sessionLogOut()'>로그아웃</span>";
	search_result = document.getElementById("search_result");

	//getNotices(0);
	/*
	notice.addEventListener('click', function(){
		if( parseInt( this.innerHTML ) >= 1 ){
			var xhr2 = new XMLHttpRequest();
			xhr2.onreadystatechange = function (event){ if(xhr2.readyState == 4 && xhr2.status == 200){
				var notices = JSON.parse( xhr2.responseText );
				for( var i = 0; i < notices.length; ++i ){
					//notice_box.innerHTML =
				}
			}}
			xhr2.open("POST", "/api/newsfeed/getnotice", false); xhr2.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); xhr2.send('cnt='+parseInt(notice.innerHTML));
		}
	});
	*/
});


socket.on( 'notice_reply_new', function( data ){
	makeToast(data.from.name + "님의 답글 : " + data.text);
});


function head_menu_show(boolean){
	event.stopPropagation();
	if( boolean != undefined ){
		if( boolean ){
			head_menu.style.display = "block";
		} else {
			head_menu.style.display = "none";
		}
	} else if( head_menu.style.display == "block" ){
		head_menu.style.display = "none";
	} else {
		head_menu.style.display = "block";
	}
}

function goTop( orix, oriy, desx, desy ){
	var Timer;
	var winHeight = document.body.scrollTop;
	if( Timer ){
		clearTimeout( Timer );
	}
	startx = 0;
	starty = winHeight;
	if( !orix || orix < 0 ){
		orix = 0;
	}
	if( !oriy || oriy < 0 ){
		oriy = 0;
	}
	var speed = 7;
	if( !desx ){
		desx = 0 + startx;
	}
	if( !desy ){
		desy = 0 + starty;
	}
	desx += ( orix - startx) / speed;
	if ( desx < 0 ) desx = 0;
	desy += ( oriy - starty) / speed;
	if ( desy < 0 ) desy = 0;
	var posX = Math.ceil( desx );
	var posY = Math.ceil( desy );
	window.scrollTo( posX, posY );
	if((Math.floor(Math.abs(startx - orix)) < 1) && (Math.floor(Math.abs(starty - oriy)) < 1)){
		clearTimeout(Timer);
		window.scroll(orix,oriy);
	} else if ( posX != orix || posY != oriy ){
		Timer = setTimeout("goTop("+orix+","+oriy+","+desx+","+desy+")",15);
	} else {
		clearTimeout(Timer);
	}
}


</script>
